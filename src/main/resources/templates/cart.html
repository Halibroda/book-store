<!doctype html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="https://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
<head th:replace="~{fragments/_head :: head(#{cart.title})}"></head>
<body>
<div th:replace="~{fragments/_navbar :: navbar}"></div>

<main class="container">
    <h1 th:text="#{cart.title}">Cart</h1>

    <div class="card" th:if="${order != null and order.bookItems != null and !order.bookItems.isEmpty()}">
        <div class="card__body">
            <div class="grid cart-grid">
                <div class="muted" th:text="#{book.title}">Title</div>
                <div class="muted" th:text="#{book.price}">Price</div>
                <div class="muted" th:text="#{cart.quantity}">Qty</div>
                <div class="muted ta-center" th:text="#{cart.actions}">Actions</div>

                <th:block th:each="bi : ${order.bookItems}">
                    <div>
                        <div th:text="${books[bi.bookId] != null ? books[bi.bookId].name : 'Unknown'}">Name</div>
                        <div class="small muted"
                             th:text="${books[bi.bookId] != null ? books[bi.bookId].author : ''}">Author</div>
                    </div>

                    <div th:text="${books[bi.bookId] != null ? books[bi.bookId].price : 0} + ' $'">0.00 $</div>

                    <div class="qty-cell">
                        <form th:action="@{/order/cart/update}" method="post" class="qty-form">
                            <input type="hidden" name="bookId" th:value="${bi.bookId}">
                            <input class="qty" type="number" name="quantity" min="1" th:value="${bi.quantity}">
                            <button class="btn btn--ghost btn-sm" type="submit" th:text="#{cart.update}">Update</button>
                            <th:block th:if="${_csrf != null}">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            </th:block>
                        </form>
                    </div>

                    <div class="actions">
                        <form th:action="@{/order/cart/remove}" method="post">
                            <input type="hidden" name="bookId" th:value="${bi.bookId}">
                            <button class="btn btn--danger btn-sm" type="submit" th:text="#{cart.remove}">Remove</button>
                            <th:block th:if="${_csrf != null}">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                            </th:block>
                        </form>
                    </div>
                </th:block>
            </div>

            <hr style="margin:16px 0; opacity:.2"/>

            <div style="display:flex; justify-content:flex-end; gap:16px; align-items:center">
                <strong th:text="#{cart.total}">Total</strong>
                <strong th:text="${order.price} + ' $'">0.00 $</strong>
            </div>
        </div>

        <div class="card__footer" style="justify-content:space-between">
            <form th:action="@{/order/cart/clear}" method="post">
                <button class="btn btn--ghost" type="submit" th:text="#{cart.clear}">Clear</button>
                <th:block th:if="${_csrf != null}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                </th:block>
            </form>

            <form th:action="@{/order/cart/submit}" method="post">
                <input type="hidden" name="orderId" th:value="${order.id}">
                <button class="btn" type="submit" th:text="#{cart.checkout}">Confirm</button>
                <th:block th:if="${_csrf != null}">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                </th:block>
            </form>
        </div>
    </div>

    <div class="container--center" th:if="${order == null or order.bookItems == null or order.bookItems.isEmpty()}">
        <p class="muted" th:text="#{cart.empty}">Your cart is empty.</p>
        <a class="btn" th:href="@{/}" th:text="#{common.backHome}">Back</a>
    </div>
</main>
</body>
</html>
